---
title: "OBIS Marine Biodata Workshop"
author: "Stace Beaulieu, Ian Brunjes"
date: "2023-04-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## R Markdown

# Use Case: Interoperable IFCB data product for the CA HAB Bulletin
# aka IFCB Dashboard to OBIS use case with automated classification
## Event core with Occurrence extension
Ian Brunjes (SCCOOS), Stace Beaulieu (WHOI)
Prepared for OBIS IOOS Marine Biological Data Mobilization Workshop April 2023
**This is a prototype for testing purposes only.**
**A protocol is being developed to determine if and when appropriate to submit products from automated classification to OBIS.**
Sponsored by NOAA PCMHAB20 project “Harmful Algal Bloom Community Technology Accelerator”

Main steps in the workflow can be related to the [IFCB workflow diagram](https://raw.githubusercontent.com/hsosik/ifcb-analysis/master/Development/IFCB%20workflow%20chart.png) in the [ifcb-analysis wiki on GitHub](https://github.com/hsosik/ifcb-analysis/wiki)

Step: Classification
- Interpretation for the autoclass scores / transform automated classification into presence/absence

Step: Matching class labels to scientific names
- Match the class labels to scientific names in the World Register of Marine Species (WoRMS) taxonomic database.

Step: Summarization
- Calculate concentration as number of ROIs classified to a taxon divided by volume analyzed

Next step (not shown / would extend the diagram): Transforming to Darwin Core
- Map resulting data table into Darwin Core table(s)

### Target data product to standardize to Darwin Core:
Concentration of 2 genera of HAB taxa from an IFCB sample(s) (e.g., [here is a sample with autoclass available in HABDAC at Del Mar Mooring](https://ifcb.caloos.org/timeline?dataset=del-mar-mooring&bin=D20210620T221255_IFCB158)

Preconditions:
- IFCB Dashboard sample (bin) has autoclass csv file with scores from automated classifier
- IFCB Dashboard sample has been populated with volume_analyzed, datetime, latitude, and longitude
- Depth of sample has been provided through some means (not presently available in IFCB Dashboard)
- For autoclass labels: A lookup table has been prepared with thresholds per class

This workflow is being developed to meet the EU Horizon 2020 “Best practices and recommendations for plankton imagery data management” http://dx.doi.org/10.25607/OBP-1742

## Classification
In this step, we interpret the autoclass scores from the autoclass.csv file on the IFCB Dashboard. We will filter to the targeted class labels, apply a threshold per class label, and determine the “winning” class label per ROI, thus transforming the automated classification into a presence/absence table.

The order of operations is important in this filtering and thresholding process. If the filtering is applied prior to thresholding, the concentration is possibly (likely) to be overestimated by excluding other classes that may have higher scores.

Our initial prototype will retain as ‘absence’ (zero count) when no ROIs exceed per-class threshold. However, we acknowledge that data providers may want to use a different per-class threshold to report absence, and might only want to report presence.

Output from the Classification step is an intermediate table loosely corresponding to Level 1b SeaBASS file (classification per ROI).

```{r , echo=FALSE}


```

## Matching class labels to scientific names
In this step, we use (a portion of) each autoclass label to query the API of the World Register of Marine Species (WoRMS) taxonomic database to return an accepted scientific name, its paired Aphia ID, and its taxon rank and kingdom.

```{r , echo=FALSE}
# example snippet
# worms_record <- worrms::wm_records_taxamatch("Alexandrium catenella", fuzzy = TRUE)[[1]]
# worms_record$lsid;  worms_record$rank; worms_record$kingdom


```

## Summarization
In this step, we use the table from the Classification step and results from the Matching to WoRMS step to calculate concentration as number of ROIs classified to a taxon divided by volume analyzed per sample.

Output from the Summarization step loosely corresponds to Level 2 SeaBASS file.

```{r , echo=FALSE}


```

## Transforming to Darwin Core
In this step, we transform the table from the Summarization step into two tables (an event table and an occurrence table) and add columns to meet OBIS and GBIF requirements for the Darwin Core Archive package.

We also add columns to meet the EU Horizon 2020 “Best practices and recommendations for plankton imagery data management” http://dx.doi.org/10.25607/OBP-1742

```{r , echo=FALSE}


```
